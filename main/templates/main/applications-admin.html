{% extends 'main/template.html' %}
{% load static %}
{% block head %}
<title>Журнал заявок</title>
{% endblock %}
{% block content %}
<div style="display: flex; flex-direction: column; align-items: center; padding: 55px 0; background-color: #454343;">
    <h1 style="color: white;">Для админов (журнал заявок)</h1>
    {% for application in applications %}
    <div class="application" data-id="{{ application.id }}" data-status="{{ application.status }}"
         style="border: 1px solid black;">
        <p style="color: #11263A;">{{ application.created_at }}</p>
        <p style="color: #11263A;"> От кого: <a href="https://vk.com/id{{ application.user.profile.vk_id }}"
                                                target="_blank">{{ application.full_name }}</a></p>
        <p style="color: #11263A;">Комната: {{ application.room }}</p>
        <p style="color: #11263A;">Описание проблемы: {{ application.description.lower }}</p>
        <button style="margin-right: 21px;" value="1" class="btn">Заявка сделана</button>
        <button value="2" class="btn">Выполнено</button>
    </div>
    {% endfor %}
</div>


<style>
    .btn {
        padding: 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        background-color: #626262;
        color: white;
    }

    .application {
        width: 1024px;
        background-color: white;
        border-radius: 5px;
        padding: 26px 40px;
        margin-bottom: 20px;
        box-sizing: border-box;
    }

    .btn-active {
        background-color: #E02420;
    }

</style>
<script>
    const applications = document.querySelectorAll('.application');
    applications.forEach(application => {
        const status = application.dataset.status;
        const buttons = application.querySelectorAll('.btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', event => {
                const isActive = btn.classList.contains('btn-active');
                if (!isActive) {
                    fetch('{% url "applications-admin" %}', {
                        method: 'POST',
                        body: JSON.stringify({'id': application.dataset.id, 'value': btn.value})
                    });
                    if (btn.value === '1') {
                        buttons[0].classList.add('btn-active');
                        buttons[1].classList.remove('btn-active');
                    } else if (btn.value === '2') {
                        buttons[0].classList.add('btn-active');
                        buttons[1].classList.add('btn-active');
                    }
                } else {
                    fetch('{% url "applications-admin" %}', {
                        method: 'POST',
                        body: JSON.stringify({'id': application.dataset.id, 'value': parseInt(btn.value) - 1})
                    });
                    if (btn.value === '1') {
                        buttons[0].classList.remove('btn-active');
                        buttons[1].classList.remove('btn-active');
                    } else if (btn.value === '2') {
                        buttons[0].classList.add('btn-active');
                        buttons[1].classList.remove('btn-active');
                    }
                }

            });
        });
        if (status === '1') {
            buttons[0].classList.add('btn-active');
            buttons[1].classList.remove('btn-active');
        } else if (status === '2') {
            buttons[0].classList.add('btn-active');
            buttons[1].classList.add('btn-active');
        }
    })
</script>
{% endblock %}